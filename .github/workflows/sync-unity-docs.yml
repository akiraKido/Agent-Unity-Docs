name: Sync Unity Docs
# Syncs Unity documentation to R2 storage

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    # フォークでは実行しない
    if: github.repository == 'akiraKido/Agent-Unity-Docs'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync Unity Documentation to R2
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          # AWS CLI の認証設定
          export AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID"
          export AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY"

          # cdn_versions.json から設定を読み込む
          CDN_JSON="Editor/cdn_versions.json"
          CLOUDMEDIA_VERSIONS=$(jq -r '.cloudmedia[]' "$CDN_JSON")
          CLOUDMEDIA_BASE=$(jq -r '.cloudmedia_base' "$CDN_JSON")
          GOOGLE_STORAGE_BASE=$(jq -r '.google_storage_base' "$CDN_JSON")

          # バージョン一覧を取得し、major.minor に変換して重複除去
          VERSIONS=$(curl -s "https://public-cdn.cloud.unity3d.com/hub/prod/releases-win32.json" \
            | jq -r '.official[].version' \
            | sed -E 's/^([0-9]+\.[0-9]+).*/\1/' \
            | sort -u -V -r)

          for VERSION in $VERSIONS; do
            R2_KEY="${VERSION}/UnityDocumentation.zip"
            FILE="UnityDocumentation.zip"

            # cloudmedia か Google Storage かを判定
            if echo "$CLOUDMEDIA_VERSIONS" | grep -q "^${VERSION}$"; then
              URL="${CLOUDMEDIA_BASE}/${VERSION}/UnityDocumentation.zip"
            else
              URL="${GOOGLE_STORAGE_BASE}/${VERSION}/UnityDocumentation.zip"
            fi

            # ドキュメントが存在するか確認
            STATUS=$(curl -sI -o /dev/null -w "%{http_code}" "$URL")
            if [ "$STATUS" != "200" ]; then
              echo "Skip $VERSION (not found at $URL)"
              continue
            fi

            # リモートの Last-Modified を Unix timestamp に変換
            REMOTE_DATE_RAW=$(curl -sI "$URL" | grep -i "last-modified" | cut -d: -f2- | xargs)
            REMOTE_DATE=$(date -d "$REMOTE_DATE_RAW" +%s 2>/dev/null || echo "")

            # R2 にある既存ファイルの Last-Modified を取得
            LOCAL_DATE=$(aws s3api head-object \
              --bucket "$R2_BUCKET" \
              --key "$R2_KEY" \
              --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
              --query "Metadata.\"source-last-modified\"" \
              --output text 2>/dev/null || echo "")

            if [ "$REMOTE_DATE" = "$LOCAL_DATE" ]; then
              echo "Skip $VERSION (not modified)"
              continue
            fi

            echo "Downloading $VERSION from $URL..."
            curl -L -o "$FILE" "$URL"

            echo "Uploading to R2..."
            aws s3 cp "$FILE" "s3://${R2_BUCKET}/${R2_KEY}" \
              --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
              --metadata source-last-modified="$REMOTE_DATE"

            rm "$FILE"
          done
