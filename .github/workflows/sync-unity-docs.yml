name: Sync Unity Docs
# Syncs Unity documentation to R2 storage

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    # フォークでは実行しない
    if: github.repository == 'akiraKido/Agent-Unity-Docs'
    steps:
      - name: Sync Unity Documentation to R2
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          # AWS CLI の認証設定
          export AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID"
          export AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY"

          # バージョン一覧を取得し、major.minor に変換して重複除去
          VERSIONS=$(curl -s "https://public-cdn.cloud.unity3d.com/hub/prod/releases-win32.json" \
            | jq -r '.official[].version' \
            | sed -E 's/^([0-9]+\.[0-9]+).*/\1/' \
            | sort -u -V -r)

          for VERSION in $VERSIONS; do
            URL="https://cloudmedia-docs.unity3d.com/docscloudstorage/en/${VERSION}/UnityDocumentation.zip"
            R2_KEY="${VERSION}/UnityDocumentation.zip"
            FILE="UnityDocumentation.zip"

            # ドキュメントが存在するか確認
            STATUS=$(curl -sI -o /dev/null -w "%{http_code}" "$URL")
            if [ "$STATUS" != "200" ]; then
              echo "Skip $VERSION (not found)"
              continue
            fi

            # リモートの Last-Modified を取得
            REMOTE_DATE=$(curl -sI "$URL" | grep -i "last-modified" | cut -d: -f2- | xargs)

            # R2 にある既存ファイルの Last-Modified を取得
            LOCAL_DATE=$(aws s3api head-object \
              --bucket "$R2_BUCKET" \
              --key "$R2_KEY" \
              --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
              --query "Metadata.source-last-modified" \
              --output text 2>/dev/null || echo "")

            if [ "$REMOTE_DATE" = "$LOCAL_DATE" ]; then
              echo "Skip $VERSION (not modified)"
              continue
            fi

            echo "Downloading $VERSION..."
            curl -L -o "$FILE" "$URL"

            echo "Uploading to R2..."
            aws s3 cp "$FILE" "s3://${R2_BUCKET}/${R2_KEY}" \
              --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
              --metadata "source-last-modified=${REMOTE_DATE}"

            rm "$FILE"
          done
